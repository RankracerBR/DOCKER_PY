<!DOCTYPE html>
{% load static %}
<html lang="en">
  <head>
    <meta charset="UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="stylesheet" href="{% static 'css/style.css'%}" />
    <title>Formulario NordDev</title>
    <style>
      #response-message {
        font-size: 16px;
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="descricao">
        <h1>Cadastro NordDev</h1>
        <p>O melhor para sua empresa</p>
      </div>
      <div id="mc_embed_signup">
        <form action="{% url 'subscribe' %}" 
          method="post" id="mc-embedded-subscribe-form" 
          name="mc-embedded-subscribe-form" 
          class="validate"
          target="_self" 
          onsubmit="return verificarEmail();"
        >
        {% csrf_token %}
          <div id="mc_embed_signup_scroll">
            <div class="formulario">
              <div class="form">
                <h1>Se inscreva</h1>
                <!-- <div class="indicates-required"><span class="asterisk">*</span> indicates required</div> -->
                <div class="mc-field-group">
                  <input
                    type="text"
                    value=""
                    name="nome"
                    class=""
                    placeholder="Nome"
                    id="mce-FNAME"
                  />
                </div>
                <div class="mc-field-group">
                  <input
                    type="text"
                    value=""
                    name="sobrenome"
                    class=""
                    placeholder="Sobrenome"
                    id="mce-LNAME"
                  />
                </div>
                <div class="mc-field-group">
                  <input
                    type="email"
                    value=""
                    name="email"
                    class="required email"
                    placeholder="Email"
                    id="mce-EMAIL"
                    required
                  />
                </div>
                <div class="mc-field-group">
                  <input
                    type="email"
                    value=""
                    name="email_verificacao"
                    class="required email"
                    placeholder="Verifique seu Email"
                    id="mce-EMAIL-verificacao"
                    required
                  />
                </div>
                <div
                  style="position: absolute; left: -50000px"
                  aria-hidden="true"
                >
                  <input
                    type="text"
                    name="b_ee6dc3c56054faf946bbd3a1c_e2426a9f0e"
                    tabindex="-1"
                    value=""
                  />
                </div>
                <div class="optionalParent">
                  <div class="clear foot">
                    <input
                      type="submit"
                      class="btn"
                      value="Enviar"
                      name="Enviar"
                      id="mc-embedded-subscribe"
                    />
                  </div>
                  <div class="optionalParent">
                    <p class="brandingLogo">
                      <a
                        href="http://eepurl.com/iq9fQI"
                        title="Mailchimp - email marketing made easy and fun"
                      ></a>
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </form>
        <div id="response-message"></div> <!-- Elemento para exibir a mensagem de resposta -->
      </div>
    </div>
    <script>
      function verificarEmail() {
        var email = document.getElementById("mce-EMAIL").value;
        var emailVerificacao = document.getElementById("mce-EMAIL-verificacao").value;
      
        if (email !== emailVerificacao) {
          alert("Os emails não correspondem!");
          return false;
        }
      
        // Obtenha o token CSRF do cookie
        var csrftoken = getCookie('csrftoken');
      
        // Fazendo a requisição AJAX para chamar a função do Django
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "{% url 'subscribe' %}", true);
        xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        xhr.setRequestHeader("X-CSRFToken", csrftoken); // Inclua o token CSRF no cabeçalho da requisição
        xhr.onreadystatechange = function () {
          if (xhr.readyState === 4) {
            if (xhr.status === 200) {
              // Lógica após receber a resposta do Django
              var response = JSON.parse(xhr.responseText);
              var responseMessage = document.getElementById("response-message");
              responseMessage.innerHTML = response.message;
              responseMessage.style.color = "green";
      
              // Redirecionar para o URL especificado no atributo action do formulário
            } else {
              // Trate erros ou falhas na requisição
              var responseMessage = document.getElementById("response-message");
              responseMessage.innerHTML = "Email Já Registrado.";
              responseMessage.style.color = "red";
            }
          }
        };
        var nome = document.getElementById("mce-FNAME").value;
        var sobrenome = document.getElementById("mce-LNAME").value;
        var data = "nome=" + encodeURIComponent(nome) + "&sobrenome=" + encodeURIComponent(sobrenome) + "&email=" + encodeURIComponent(email);
        xhr.send(data);
      
        return false; // Para evitar o envio do formulário pelo navegador
      }
      
      // Função para obter o valor do cookie do token CSRF
      function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
          var cookies = document.cookie.split(';');
          for (var i = 0; i < cookies.length; i++) {
            var cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === name + '=') {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }   
    </script>
  </body>
</html>